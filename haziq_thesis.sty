%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% PACKAGES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Structure
\usepackage[centering]{geometry}
\geometry{%
  a4paper,
  left=40mm,
  right=23mm,
  top=30mm,
  bottom=35mm,
%  footskip=10mm,
  marginparwidth=25mm,
  marginparsep=0mm,
  bindingoffset=0mm
 }
\usepackage{standalone}
\usepackage{subfiles}
\usepackage{import}
\usepackage{morewrites}  % https://tex.stackexchange.com/questions/289734/special-package-combination-gives-no-room-for-new-write
\usepackage[all]{nowidow}  % https://tex.stackexchange.com/questions/4152/how-do-i-prevent-widow-orphan-lines

% Footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\fancyhf{}
\renewcommand{\chaptermark}[1]{%
  \markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection~#1}}
\fancyfoot[LE,RO]{\small\thepage}
%\fancyfoot[RE,LO]{\small\nouppercase{\leftmark}~--- \nouppercase{\rightmark}}  % if oneside
\fancyfoot[RE]{\small\nouppercase{\leftmark}}  % if twoside
\fancyfoot[LO]{\small\nouppercase{\rightmark}}  % if twoside

\fancypagestyle{plain}{%
  \fancyhf{}
  \fancyfoot[LE,RO]{\small\thepage}
}

% Typeset and appearance
\usepackage[english]{babel}   % manages structure of paper better
\usepackage[]{xcolor}  % options: usenames, dvipsnames, svgnames, table
\usepackage{soul}  % for highlighting text
\usepackage{url}
\usepackage{hyperref}  % hyperref setup at the bottom
\usepackage{footmisc}  % ability to reuse footnotes 
% https://tex.stackexchange.com/questions/40072/incompatibility-between-footmisc-option-multiple-and-hyperref/62091#62091

\let\oldFootnote\footnote
\newcommand\nextToken\relax

\renewcommand\footnote[1]{%
    \oldFootnote{#1}\futurelet\nextToken\isFootnote}

\newcommand\isFootnote{%
    \ifx\footnote\nextToken\textsuperscript{,}\fi}
    
\usepackage[utf8]{inputenc}  % To get accents on letters
\usepackage[T1]{fontenc}     % e.g. \"a
\usepackage{ifxetex}
\ifxetex
  \usepackage{fontspec}  % phonetics, needs XeLaTeX or LuaLaTeX
  \newfontfamily\dsil{Doulos SIL}
\else
  \usepackage{lmodern}
\fi
\usepackage{nicefrac}  % To get nice typography for units
\usepackage{units}  % and fractions
\usepackage{enumitem}  % replacing enumerate
\usepackage{xr}  % Cross-referencing between files

% Show labels in margins. See https://tex.stackexchange.com/questions/45634/printing-labels-along-with-equation-numbers
\usepackage{seqsplit}
\usepackage{xstring}
\usepackage[notref,notcite]{showkeys}
\renewcommand*\showkeyslabelformat[1]{%
\noexpandarg%
\StrSubstitute{#1}{ }{~}[\TEMP]%
\parbox[c]{0.85\marginparwidth}{\raggedright\singlespacing\normalfont\small\ttfamily\expandafter\seqsplit\expandafter{\TEMP}}
}

% Git info
\usepackage[maxdepth=8,mark,raisemark=0.9323\paperheight]{gitinfo2}
\renewcommand{\gitMark}{Branch:\;\gitBranch\,@\,\gitAbbrevHash{}~\textbullet{}~Change:\;\gitAuthorIsoDate~\textbullet{}~haziqj}
\makeatletter
\def\gitMarkFormat{%
  \color{gray}\small\ttfamily
  \if@twoside%
    \ifodd\thepage\hspace{1.5cm}\else\hspace{-1.5cm}\fi
  \else
    \hspace{1.5cm}
  \fi
}
\makeatother

% Colour-blind safe pallete
\definecolor{colblu}{RGB}{0,114,178}
\definecolor{colcya}{RGB}{86,180,233}
\definecolor{colgre}{RGB}{0,158,115}
\definecolor{colgyl}{RGB}{204,204,85}
\definecolor{colgry}{RGB}{119,119,119}
\definecolor{colpur}{RGB}{204,121,167}
\definecolor{colred}{RGB}{238,51,51}%{213,94,0}
\definecolor{colora}{RGB}{230,159,0}
\definecolor{colyel}{RGB}{240,228,66}%{255,238,51}

% LSE colour pallete
\definecolor{lsered}{RGB}{244,49,49}
\definecolor{lsegry}{RGB}{167,180,187}
\definecolor{lselgr}{RGB}{217,223,223}
\definecolor{lsecya}{RGB}{124,230,216}
\definecolor{lsepur}{RGB}{134,49,166}
\definecolor{lsedpr}{RGB}{93,49,94}
\definecolor{lseblu}{RGB}{85,172,238}
\definecolor{lsegrn}{HTML}{C1EDCC}

% Coding
\usepackage{algorithm}
\usepackage{algpseudocode}
\let\proglang=\textsf
\newcommand{\pkg}[1]{{\fontseries{b}\selectfont #1}}
\newcommand{\code}[1]{\texttt{\detokenize{#1}}}

% Bibliography
\usepackage[style=authoryear-comp, firstinits=false, giveninits=false, maxcitenames=2, uniquelist=false,
  minnames=1, maxbibnames=99, backend=biber, natbib]{biblatex}
\setlength\bibitemsep{1.5\itemsep}
\AtEveryCite{\color{lsedpr}}
\makeatletter
\AtEveryCitekey{\global\undef\cbx@lastyear}  % https://tex.stackexchange.com/questions/309697/multiple-citations-same-author-same-year-using-biblatex-list-year
\makeatother
    
% Paragraph settings
\usepackage{parskip}  
\setlength{\parindent}{15pt}  % default indentation

% Line spacing
\usepackage{setspace}\onehalfspacing % or \singlespacing, \onehalfspacing or \doublespacing

% Figures
\usepackage{float}  
\usepackage{graphicx}
%\usepackage{subfig} 
\usepackage{subcaption}  % an alternative package for sub-figures (preferred)
  \newcommand{\subfloat}[2][need a sub-caption]{\subcaptionbox{#1}{#2}}  % knitr
\usepackage{rotfloat}	
\usepackage{tikz}
\usetikzlibrary{fit,positioning,calc,decorations.pathreplacing,shapes.geometric,backgrounds}
\usepackage{forest}
\usetikzlibrary{arrows}
\usetikzlibrary{shapes.callouts}
\usetikzlibrary{patterns,hobby}
\usepackage{pgfplots}    % these are for squiggly lines
\pgfplotsset{compat=1.6}  % https://tex.stackexchange.com/questions/160237/draw-somewhat-random-function/160274
\usepackage{placeins}  % make figure stay within subsections---https://tex.stackexchange.com/questions/118662/use-placeins-for-subsections
\makeatletter
\AtBeginDocument{%
  \expandafter\renewcommand\expandafter\subsection\expandafter
    {\expandafter\@fb@secFB\subsection}%
  \newcommand\@fb@secFB{\FloatBarrier
    \gdef\@fb@afterHHook{\@fb@topbarrier \gdef\@fb@afterHHook{}}}%
  \g@addto@macro\@afterheading{\@fb@afterHHook}%
  \gdef\@fb@afterHHook{}%
}
\makeatother

% Tables
\usepackage{longtable}
\usepackage{tabularx}
\usepackage{multirow}
%\usepackage{dcolumn}  % align columns on a decimal point
\newcommand{\Top}{\rule{0pt}{2.6ex}}  % Top strut for tables
\newcommand{\Bot}{\rule[-1.2ex]{0pt}{0pt}}  % Top strut for tables
\usepackage{booktabs}
\usepackage{colortbl}
\usepackage{lscape}  % landscape tables
\usepackage{threeparttable}
\usepackage{tablefootnote}

% Margin notes
\usepackage{marginnote}
\usepackage{mparhack}  % these two packages provides some fixes to marginnote
\usepackage{marginfix}

% TOC
\usepackage{tocloft}
\setlength{\cftfigindent}{0pt}  % indentations of fig and tab list
\setlength{\cfttabindent}{0pt}
%\tocloftpagestyle{myplain}

% Miscellaneous
\usepackage{lipsum} 
\usepackage{ifthen}
\usepackage{xparse}
\usepackage[linecolor=yellow, backgroundcolor=yellow!25, bordercolor=yellow, textsize=footnotesize]{todonotes}
  \newcounter{todocounter}
  \newcommand{\todonum}[2][To-do in Section \thesubsection]{\stepcounter{todocounter}\todo[caption={\thetodocounter. #1}]{\thetodocounter. #2}{}}
  \newcommand{\notodo}[1][To-do in Section \thesubsection]{\stepcounter{todocounter}\todo[caption={\thetodocounter. #1},noline,backgroundcolor=white, bordercolor=white]{}{}}
  \DeclareDocumentCommand{\hltodo}{omo}{\IfNoValueTF{#1}{\IfNoValueTF{#3}{\hl{#2}\notodo[#2]}{\hl{#2}\notodo[#3]}}{\IfNoValueTF{#3}{\hl{#2}\todonum[#1]{#1}}{\hl{#2}\todonum[#3]{#1}}}}
\usepackage{pifont}
  \newcommand{\cmark}{\ding{51}}  % check mark
  \newcommand{\xmark}{\ding{55}}  % x mark

% Glossary, abbreviations and indices
\usepackage{imakeidx}
\usepackage[abbreviations,counter=chapter,nopostdot=false,symbols,autoseeindex=true,indexcrossrefs=true]{glossaries-extra}
%\renewcommand*{\glossarypreamble}{\emph{Numbers refer to the \textbf{chapter} where the entry was referenced.}}
\makeglossaries
%\makeindex[columns=2]

% Create new macro \indx and \newabbreviationindex
\newcommand{\indx}[1]{{#1}\index{#1}}
\newcommand{\newabbreviationindex}[4]{
  \newabbreviation[#4]{#1}{#2}{#3}
  \index{#3|see{#2}}
}

% Automatically index the location of entry in the glossary
% for those entries that are in the "general" category:
%\glssetcategoryattribute{general}{indexname}{textbf}
%\glssetcategoryattribute{general}{dualindex}{true}

% Only index first use for the glossary location lists
% (doesn't affect the indexing from "dualindex" attribute):
%\glssetcategoryattribute{general}{indexonlyfirst}{true}

% Automatically index the location of entry in the glossary
% for those entries that are in the "abbreviation" category
% and use "textbf" as the encap:
\glssetcategoryattribute{abbreviation}{indexname}{textbf}
\glssetcategoryattribute{abbreviation}{dualindex}{true}

% Only index first use for the glossary location lists
% (doesn't affect the indexing from "dualindex" attribute):
%\glssetcategoryattribute{abbreviation}{indexonlyfirst}{true}

% Convert the first letter of the name to upper case in the 
% glossary for abbreviation entries:
%\glssetcategoryattribute{abbreviation}{glossname}{firstuc}

% Allow "format" key to override "dualindex" attribute.
\GlsXtrEnableIndexFormatOverride

% use first field instead of name field
%\renewcommand*{\glsxtrautoindexentry}[1]{\string\glsentryfirst{#1}}

% use long form for the sort value, if provided:
%\renewcommand*{\glsxtrautoindexassignsort}[2]{%
%  \ifglshaslong{#2}%
%  {\glsletentryfield{#1}{#2}{long}}%
%  {\glsletentryfield{#1}{#2}{sort}}%
%}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% MY THESIS SPECIFIC MACROS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% For my thesis---adds a chapter heading, including to-do list and TOC (STANDALONE VERSION)

% Textbox freely placed on page. Adapted from https://tex.stackexchange.com/questions/24663/how-to-place-a-floating-text-box-at-a-specified-location-in-page-coordinates
\newcommand{\placetextbox}[3]{% \placetextbox{<horizontal pos>}{<vertical pos>}{<stuff>}
  \setbox0=\hbox{#3}% Put <stuff> in a box
\AddToShipoutPictureFG*{\put(\LenToUnit{#1\paperwidth},\LenToUnit{#2\paperheight}){\makebox[0pt][c]{\begin{tabular}{l}#3\end{tabular}}}}
}%

\newcommand{\hChapterStandalone}[2][1]{
  \ifstandalone
    \begingroup
    \let\clearpage\relax  % Don't allow page break
%    \pagenumbering{roman}
    {\hypersetup{allcolors=.} %pdfborder=0 0 0
      \listoftodos[\vspace{-3.03cm}To-do list]
      \vspace{-1em}
      \tableofcontents
    }
    \endgroup

%    \pagenumbering{arabic}
    \setcounter{chapter}{#1-1}
    \chapter{#2}
    %0.475, 0.8175
    \placetextbox{0.5155}{0.867}{
      Haziq Jamil \\[-0.3em]
      {\it\small Department of Statistics} \\[-0.35em]
      {\it\small London School of Economics and Political Science} \\[-0.35em]
      {\small PhD thesis: `Regression modelling using Fisher information covariance kernels (I-priors)'}
    }
  \fi
}

% Adds Bibliography to TOC
\newcommand{\hPrintBibliography}{
  \printbibliography
  \addcontentsline{toc}{chapter}{Bibliography}
}

% List of figures, tables, symbols, and abbreviations
\newcommand{\hLists}{
  \newpage
  \renewcommand{\listfigurename}{Figures}
  \listoffigures
  \addcontentsline{toc}{chapter}{Figures}
  
  \newpage
  \renewcommand{\listtablename}{Tables}  
  \listoftables
  \addcontentsline{toc}{chapter}{Tables}
  
  \newpage
  \renewcommand{\listtheoremname}{Theorems}  
  \listoftheorems[ignoreall,onlynamed={theorem,lemma,corollary, proposition},numwidth=2.7em]
  \addcontentsline{toc}{chapter}{Theorems}
  
  \newpage
  \renewcommand{\listtheoremname}{Definitions}
  \listoftheorems[ignoreall,show={definition}, numwidth=2.7em]
  \addcontentsline{toc}{chapter}{Definitions}   
        
  \begingroup
    \singlespacing
    \hnomenclature
    \addcontentsline{toc}{chapter}{Nomenclature}   
    \printabbreviations[title={Abbreviations},style=long,nogroupskip, nonumberlist,nopostdot]
    \glsaddall[types=abbreviations]
  \endgroup
}

% Manual input of nomenclature, depending on individual tex files or main thesis
\newcommand{\hnomenclature}{
  \hypersetup{
  colorlinks=true,
  linkcolor=lsedpr,
  citecolor=lsedpr,
  urlcolor=lsepur
}
  \ifstandalone
    \input{../../nomenclature}
  \else 
    \input{nomenclature}
  \fi
}

% Adds the closing stuff (STANDALONE VERSION)
\newcommand{\hClosingStuffStandalone}{
  \ifstandalone
    {\hypersetup{allcolors=.} %pdfborder=0 0 0
      \hPrintBibliography
      \hLists
%      \printindex
    }
  \fi
}

% Adds TOC and lists (MAIN VERSION)
\newcommand{\hTOCandLists}{
  {\hypersetup{allcolors=.} %pdfborder=0 0 0
    \listoftodos[To-do list]
    \tableofcontents
    \hLists
    \input{nomenclature}
  }
}

% Cleverref needs to be loaded last
\usepackage[capitalise,noabbrev,nameinlink]{cleveref}
\Crefname{misc}{Miscellanea}{Miscellanea}
\Crefname{supchap}{Supplementary Chapter}{Supplementary Chapter}
\Crefname{equation}{}{}
\hypersetup{
  colorlinks=true,
  linkcolor=lsedpr,
  citecolor=lsedpr,
  urlcolor=lsepur
}
\newcommand{\mypageref}[1]{%
  \ifstandalone
    {{\color{lsedpr}p.} \pageref{#1}}%
  \else
    \cpageref{#1}%
  \fi
}

% Page intentionally left blank
%\makeatletter
%\def\cleardoublepage{\clearpage\if@twoside%
%    \ifodd\c@page\else
%    \vspace*{\fill}
%%    \vspace{3cm}
%    \hfill
%%    \begin{center}
%%    \emph{This page intentionally left blank.}
%%    \end{center}
%%    \vspace{\fill}
%    \thispagestyle{empty}
%    \newpage
%    \if@twocolumn\hbox{}\newpage\fi\fi\fi
%}
%\makeatother
% https://tex.stackexchange.com/questions/290802/page-intentionally-left-blank-with-twoside-openright/308522

%\usepackage[fontsize=10.5]{scrextend}  % place here due to conflict

% Coloured parantheses
\newcommand{\colp}[1]{{\color{lsedpr}(#1)}}


